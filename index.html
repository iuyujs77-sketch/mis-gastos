<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance √âlite 360 - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #0b141e; color: #fff; }
        .dark-bg { background-color: #0b141e; }
        .gold-text { color: #d4af37; }
        .gold-bg { background: #d4af37; }
        .card-white { background-color: #ffffff; border-radius: 20px; padding: 18px; color: #1a202c; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .card-dark { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 25px; padding: 18px; }
        .input-premium { background: transparent; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px 0; width: 100%; outline: none; color: #fff; font-size: 14px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        nav { background-color: #0b141e; border-top: 1px solid rgba(255,255,255,0.1); }
        .tab-active { border-bottom: 2px solid #d4af37; color: #d4af37; }
        select option { background-color: #0b141e; color: white; }
        input[type="date"], input[type="month"], input[type="datetime-local"] { color-scheme: dark; }
    </style>
</head>
<body class="pb-28">
    <div id="app"></div>

    <nav class="fixed bottom-0 left-0 right-0 px-8 py-4 flex justify-between items-center z-50 shadow-2xl">
        <button onclick="cambiarVista('home')" class="flex flex-col items-center gap-1 opacity-50 focus:opacity-100">
            <span class="text-xl">üè†</span>
            <span class="text-[9px] font-bold uppercase text-slate-400">Inicio</span>
        </button>
        <button onclick="cambiarVista('corte')" class="flex flex-col items-center gap-1 opacity-50 focus:opacity-100">
            <span class="text-xl">üìä</span>
            <span class="text-[9px] font-bold uppercase text-slate-400">Corte</span>
        </button>
        <button onclick="cambiarVista('metas')" class="flex flex-col items-center gap-1 opacity-50 focus:opacity-100">
            <span class="text-xl">üéØ</span>
            <span class="text-[9px] font-bold uppercase text-slate-400">Metas</span>
        </button>
        <button onclick="cambiarVista('config')" class="flex flex-col items-center gap-1 opacity-50 focus:opacity-100">
            <span class="text-xl">‚öôÔ∏è</span>
            <span class="text-[9px] font-bold uppercase text-slate-400">Ajustes</span>
        </button>
    </nav>

    <script>
        // --- ESTADO ---
        let config = JSON.parse(localStorage.getItem('e360_config')) || {
            nombre: "Usuario",
            metodos: [
                { nombre: 'Efectivo', tipo: 'debito' },
                { nombre: 'Amex', tipo: 'credito' },
                { nombre: 'BBVA D√©bito', tipo: 'debito' }
            ],
            categorias: ['Comida', 'S√∫per', 'Gasolina', 'Gym'],
            conceptosIngreso: ['N√≥mina', 'Bono'],
            recurrentes: [],
            metas: []
        };
        let movimientos = JSON.parse(localStorage.getItem('e360_movs')) || [];
        let vistaActual = 'home';
        let tipoActual = 'gasto';
        let subVistaCorte = 'mes';
        // Obtener fecha local correcta para el filtro inicial
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        let fechaFiltroCorte = now.toISOString().slice(0, 10);

        function render() {
            const container = document.getElementById('app');
            if (vistaActual === 'corte') renderCorte(container);
            else if (vistaActual === 'metas') renderMetas(container);
            else if (vistaActual === 'config') renderConfig(container);
            else renderHome(container);
        }

        function renderHome(c) {
            const stats = calcularGlobal();
            c.innerHTML = `
                <div class="pt-10 px-8 mb-12 animate-up">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 rounded-full border border-gold-text/50 flex items-center justify-center bg-slate-800 font-bold gold-text text-xl shadow-lg">F</div>
                        <p class="text-[10px] font-bold gold-text uppercase">Finance √âlite ‚Ä¢ ${config.nombre}</p>
                    </div>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">Balance General</p>
                    <h2 class="text-5xl font-extrabold text-white tracking-tighter mb-4">$${stats.totalBalance.toLocaleString()}</h2>
                </div>

                <div class="max-w-md mx-auto px-5 space-y-8 animate-up">
                    ${config.recurrentes.length > 0 ? 
                        `<button onclick="procesarRecurrentes()" class="w-full bg-white/5 border border-white/10 text-slate-300 py-3 rounded-xl font-bold uppercase text-[9px] mb-4 flex items-center justify-center gap-2">
                            <span>‚ôªÔ∏è</span> Procesar Suscripciones del Mes
                        </button>` : ''}

                    <div class="overflow-x-auto no-scrollbar flex gap-4">
                        ${config.metodos.map(m => {
                            const bal = stats.porMetodo[m.nombre] || 0;
                            const isCred = m.tipo === 'credito';
                            return `<div class="min-w-[155px] card-white flex flex-col justify-between h-36">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded bg-slate-900 flex items-center justify-center text-[10px] text-white font-bold">${isCred ? 'üí≥' : 'üíµ'}</div>
                                    <span class="text-[10px] font-extrabold text-slate-800 uppercase">${m.nombre}</span>
                                </div>
                                <div>
                                    <p class="text-[7px] text-slate-400 font-bold mb-1 uppercase">${isCred ? 'Deuda' : 'Disponible'}</p>
                                    <p class="text-lg font-extrabold ${isCred && bal > 0 ? 'text-red-600' : 'text-slate-900'} leading-none">$${Math.abs(bal).toLocaleString()}</p>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>

                    <div class="card-dark space-y-4 shadow-2xl border border-white/5">
                        <div class="flex bg-white/5 rounded-2xl p-1 border border-white/10">
                            <button onclick="tipoActual='gasto'; render();" class="flex-1 py-3 rounded-xl text-[10px] font-bold ${tipoActual === 'gasto' ? 'bg-white text-slate-900' : 'text-slate-400'} uppercase">Gasto</button>
                            <button onclick="tipoActual='ingreso'; render();" class="flex-1 py-3 rounded-xl text-[10px] font-bold ${tipoActual === 'ingreso' ? 'bg-white text-slate-900' : 'text-slate-400'} uppercase">Ingreso</button>
                            <button onclick="tipoActual='abono'; render();" class="flex-1 py-3 rounded-xl text-[10px] font-bold ${tipoActual === 'abono' ? 'bg-gold-bg text-slate-900' : 'text-slate-400'} uppercase">Abonar</button>
                        </div>
                        
                        <input type="number" id="monto" inputmode="decimal" placeholder="0.00" class="input-premium text-4xl font-extrabold text-white text-center border-white/20 pb-4">
                        
                        <div class="grid grid-cols-2 gap-4">
                            ${tipoActual === 'abono' ? `
                                <select id="metodo_origen" class="input-premium"><option disabled selected>Desde (D√©bito)</option>${config.metodos.filter(x=>x.tipo==='debito').map(m=>`<option value="${m.nombre}">${m.nombre}</option>`)}</select>
                                <select id="metodo" class="input-premium"><option disabled selected>Hacia (Cr√©dito)</option>${config.metodos.filter(x=>x.tipo==='credito').map(m=>`<option value="${m.nombre}">${m.nombre}</option>`)}</select>
                            ` : `
                                <select id="cat" class="input-premium"><option disabled selected>Concepto</option>${(tipoActual==='gasto' ? config.categorias : config.conceptosIngreso).map(c=>`<option value="${c}">${c}</option>`)}</select>
                                <select id="metodo" class="input-premium"><option disabled selected>Cuenta</option>${config.metodos.map(m=>`<option value="${m.nombre}">${m.nombre}</option>`)}</select>
                            `}
                        </div>
                        <input type="datetime-local" id="fecha_mov" class="input-premium border-none">
                        <input type="text" id="desc" placeholder="Descripci√≥n (opcional)" class="input-premium">
                        <button onclick="registrar()" class="w-full gold-bg text-slate-900 py-4 rounded-2xl font-bold uppercase text-[10px] shadow-lg">Confirmar</button>
                    </div>
                </div>`;
            
            // CORRECCI√ìN DE HORA AUTOM√ÅTICA
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('fecha_mov').value = now.toISOString().slice(0, 16);
        }

        function renderCorte(c) {
            const data = calcularCorte(subVistaCorte, fechaFiltroCorte);
            c.innerHTML = `
                <div class="p-8 animate-up">
                    <h1 class="text-2xl font-extrabold text-white mb-6 uppercase text-center">Auditor√≠a</h1>
                    <div class="flex justify-between border-b border-white/10 mb-6 px-2">
                        <button onclick="subVistaCorte='dia'; render();" class="pb-3 text-xs font-bold uppercase ${subVistaCorte === 'dia' ? 'tab-active' : 'opacity-40'}">D√≠a</button>
                        <button onclick="subVistaCorte='semana'; render();" class="pb-3 text-xs font-bold uppercase ${subVistaCorte === 'semana' ? 'tab-active' : 'opacity-40'}">Semana</button>
                        <button onclick="subVistaCorte='mes'; render();" class="pb-3 text-xs font-bold uppercase ${subVistaCorte === 'mes' ? 'tab-active' : 'opacity-40'}">Mes</button>
                    </div>

                    <div class="mb-8">
                        <label class="text-[9px] font-bold text-slate-500 uppercase ml-2">Seleccionar Fecha</label>
                        <input type="${subVistaCorte==='mes'?'month':'date'}" value="${fechaFiltroCorte.slice(0, subVistaCorte==='mes'?7:10)}" 
                               onchange="fechaFiltroCorte=this.value; render();" class="w-full bg-white/5 p-4 rounded-xl mt-1 text-sm outline-none border border-white/10">
                    </div>

                    <div class="space-y-6 text-center">
                        <div class="card-white">
                            <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Balance Periodo</p>
                            <h3 class="text-4xl font-extrabold ${data.neto >= 0 ? 'text-green-600' : 'text-red-600'}">$${data.neto.toLocaleString()}</h3>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="card-dark border-l-4 border-green-500"><p class="text-[8px] text-slate-500 uppercase">Ingresos</p><p class="text-xl font-bold">$${data.ingresos.toLocaleString()}</p></div>
                            <div class="card-dark border-l-4 border-red-500"><p class="text-[8px] text-slate-500 uppercase">Gastos</p><p class="text-xl font-bold">$${data.gastos.toLocaleString()}</p></div>
                        </div>
                    </div>
                </div>`;
        }

        function renderMetas(c) {
            c.innerHTML = `
                <div class="p-8 animate-up">
                    <h1 class="text-2xl font-extrabold text-white mb-8 tracking-tight uppercase text-center">Metas</h1>
                    <div class="card-white mb-8 space-y-4">
                        <input type="text" id="meta_nombre" placeholder="Nombre" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none text-slate-900 border">
                        <input type="number" id="meta_monto" placeholder="Monto objetivo $" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none text-slate-900 border">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase ml-2">Fecha l√≠mite</label>
                            <input type="date" id="meta_fecha" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none text-slate-900 mt-1 border">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="agregarMeta('ahorro')" class="flex-1 bg-slate-900 text-white py-4 rounded-xl font-bold uppercase text-[9px]">Ahorro ‚úàÔ∏è</button>
                            <button onclick="agregarMeta('deuda')" class="flex-1 bg-red-600 text-white py-4 rounded-xl font-bold uppercase text-[9px]">Deuda üìâ</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${config.metas.map((m, i) => `<div class="card-white border-l-4 ${m.tipo==='deuda'?'border-red-500':'border-gold-bg'}">
                            <h4 class="font-extrabold">${m.nombre}</h4>
                            <p class="text-[9px] uppercase mt-1">Meta: $${parseFloat(m.monto).toLocaleString()} ‚Ä¢ ${m.fecha}</p>
                            <button onclick="borrarMeta(${i})" class="text-red-500 text-[8px] font-bold uppercase mt-2">Eliminar</button>
                        </div>`).join('')}
                    </div>
                </div>`;
        }

        function renderConfig(c) {
            c.innerHTML = `
                <div class="p-8 animate-up pb-32">
                    <h1 class="text-2xl font-extrabold text-white mb-8 text-center uppercase">Ajustes</h1>
                    
                    <div class="mb-8">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-2 ml-2 tracking-widest">Perfil</h3>
                        <div class="card-white">
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Titular</label>
                            <input type="text" id="titularNom" value="${config.nombre}" onchange="updateNombre(this.value)" class="w-full mt-1 p-2 bg-slate-100 rounded-lg font-bold text-slate-900 outline-none">
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-2 ml-2 tracking-widest">Cartera</h3>
                        <div class="card-white space-y-4">
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Nueva Cuenta</p>
                                <div class="flex gap-2">
                                    <input type="text" id="newCta" placeholder="Ej: BBVA" class="flex-1 p-3 bg-slate-100 rounded-lg text-sm font-bold text-slate-900 outline-none">
                                    <select id="ctaTipo" class="p-3 bg-slate-100 rounded-lg text-xs font-bold text-slate-900 outline-none">
                                        <option value="debito">D√©bito</option>
                                        <option value="credito">Cr√©dito</option>
                                    </select>
                                    <button onclick="addItemMetodo()" class="gold-bg px-4 rounded-lg font-bold">+</button>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${config.metodos.map((m, i) => `<span class="bg-slate-100 p-2 rounded-lg text-[9px] font-bold border border-slate-200">${m.nombre} <span class="text-[8px] text-slate-400 ml-1">(${m.tipo === 'credito' ? 'CR' : 'DB'})</span> <button onclick="removeItem('metodos',${i})" class="text-red-500 ml-1 font-bold">√ó</button></span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-2 ml-2 tracking-widest">Clasificaci√≥n</h3>
                        <div class="card-white mb-4">
                            <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Fuentes de Ingreso</p>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="newIngreso" placeholder="Ej: Freelance" class="flex-1 p-3 bg-slate-100 rounded-lg text-sm font-bold text-slate-900 outline-none">
                                <button onclick="addItem('conceptosIngreso', 'newIngreso')" class="bg-green-100 text-green-700 px-4 rounded-lg font-bold border border-green-200">+</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${config.conceptosIngreso.map((c,i)=>`<span class="bg-green-50 text-green-800 p-2 rounded-lg text-[9px] font-bold border border-green-100">${c} <button onclick="removeItem('conceptosIngreso',${i})" class="ml-1">√ó</button></span>`).join('')}
                            </div>
                        </div>
                        <div class="card-white">
                            <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Categor√≠as de Gasto</p>
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="newCat" placeholder="Ej: Renta" class="flex-1 p-3 bg-slate-100 rounded-lg text-sm font-bold text-slate-900 outline-none">
                                <button onclick="addItem('categorias', 'newCat')" class="bg-red-100 text-red-700 px-4 rounded-lg font-bold border border-red-200">+</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${config.categorias.map((c,i)=>`<span class="bg-red-50 text-red-800 p-2 rounded-lg text-[9px] font-bold border border-red-100">${c} <button onclick="removeItem('categorias',${i})" class="ml-1">√ó</button></span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-2 ml-2 tracking-widest">Automatizaci√≥n</h3>
                        <div class="card-white">
                            <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Suscripciones Recurrentes</p>
                            <div class="grid grid-cols-4 gap-2 mb-2">
                                <input type="text" id="recNom" placeholder="Nombre" class="col-span-2 p-3 bg-slate-100 rounded-lg text-xs font-bold outline-none">
                                <input type="number" id="recMon" placeholder="$" class="col-span-1 p-3 bg-slate-100 rounded-lg text-xs font-bold outline-none">
                                <input type="number" id="recDia" placeholder="D√≠a" min="1" max="31" class="col-span-1 p-3 bg-slate-100 rounded-lg text-xs font-bold outline-none text-center">
                            </div>
                            <select id="recCta" class="w-full p-3 bg-slate-100 rounded-lg text-xs font-bold mb-3 outline-none text-slate-700">${config.metodos.map(m=>`<option value="${m.nombre}">${m.nombre}</option>`)}</select>
                            <button onclick="addRecurrente()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-[10px] uppercase">Guardar Suscripci√≥n</button>
                            
                            <div class="mt-4 space-y-2">
                                ${config.recurrentes.map((r, i) => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100"><span class="text-[9px] font-bold text-slate-700">üìÖ ${r.dia} ‚Ä¢ ${r.nombre} ($${r.monto})</span><button onclick="removeItem('recurrentes',${i})" class="text-red-400 text-xs font-bold">√ó</button></div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <button onclick="if(confirm('¬øBorrar todo?')){localStorage.clear();location.reload();}" class="w-full text-red-500 font-bold uppercase text-[10px] pt-4 pb-8">Restablecer Aplicaci√≥n</button>
                </div>`;
        }

        // --- FUNCIONES ---
        function updateNombre(v) { config.nombre = v; save(); render(); }

        function registrar() {
            const m = document.getElementById('monto').value;
            const fecha = document.getElementById('fecha_mov').value;
            if(!m) return alert('Ingresa monto');

            if(tipoActual === 'abono'){
                const origen = document.getElementById('metodo_origen').value;
                const destino = document.getElementById('metodo').value;
                movimientos.unshift({ monto: m, tipo: 'gasto', cat: 'Pago Tarjeta', metodo: origen, fecha: fecha });
                movimientos.unshift({ monto: m, tipo: 'ingreso', cat: 'Abono Deuda', metodo: destino, fecha: fecha });
            } else {
                const met = document.getElementById('metodo').value;
                const cat = document.getElementById('cat').value;
                movimientos.unshift({ monto: m, tipo: tipoActual, cat: cat, metodo: met, desc: document.getElementById('desc').value, fecha: fecha });
            }
            save(); render();
        }

        function procesarRecurrentes() {
            if(!confirm("¬øRegistrar todas las suscripciones de este mes?")) return;
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = String(hoy.getMonth() + 1).padStart(2, '0');
            
            config.recurrentes.forEach(rec => {
                const diaFormato = String(rec.dia).padStart(2, '0');
                const fechaGenerada = `${year}-${month}-${diaFormato}T12:00`; 
                
                movimientos.unshift({
                    monto: rec.monto,
                    tipo: 'gasto',
                    cat: 'Recurrente',
                    metodo: rec.cuenta,
                    desc: `Cargo: ${rec.nombre}`,
                    fecha: fechaGenerada
                });
            });
            alert("Suscripciones procesadas con √©xito.");
            save(); render();
        }

        function calcularGlobal() {
            let total = 0, porMetodo = {};
            movimientos.forEach(mov => {
                const cta = config.metodos.find(x => x.nombre === mov.metodo);
                if(!cta) return;
                const monto = parseFloat(mov.monto);
                if(!porMetodo[mov.metodo]) porMetodo[mov.metodo] = 0;
                
                if(mov.tipo === 'ingreso') {
                    if(cta.tipo === 'debito') { total += monto; porMetodo[mov.metodo] += monto; }
                    else porMetodo[mov.metodo] -= monto;
                } else {
                    if(cta.tipo === 'debito') { total -= monto; porMetodo[mov.metodo] -= monto; }
                    else porMetodo[mov.metodo] += monto;
                }
            });
            return { totalBalance: total, porMetodo };
        }

        function calcularCorte(periodo, fechaRef) {
            let i = 0, g = 0; 
            const refStr = fechaRef.slice(0, 10); 
            const refMesStr = fechaRef.slice(0, 7);
            const refDate = new Date(fechaRef);

            movimientos.forEach(m => {
                const movStr = m.fecha.slice(0, 10);
                const movMesStr = m.fecha.slice(0, 7);
                const movDate = new Date(m.fecha);

                let match = false;
                if(periodo === 'dia') match = movStr === refStr;
                else if(periodo === 'mes') match = movMesStr === refMesStr;
                else if(periodo === 'semana') match = Math.abs(refDate - movDate) / 864e5 <= 7;

                if(match) { if(m.tipo==='ingreso') i+=parseFloat(m.monto); else g+=parseFloat(m.monto); }
            });
            return { ingresos: i, gastos: g, neto: i - g };
        }

        function save() { localStorage.setItem('e360_config', JSON.stringify(config)); localStorage.setItem('e360_movs', JSON.stringify(movimientos)); }
        function cambiarVista(v) { vistaActual = v; render(); }
        function addItemMetodo() { const n = document.getElementById('newCta').value, t = document.getElementById('ctaTipo').value; if(n){ config.metodos.push({nombre:n, tipo:t}); save(); render(); } }
        
        function addRecurrente() { 
            const n = document.getElementById('recNom').value;
            const m = document.getElementById('recMon').value;
            const c = document.getElementById('recCta').value;
            const d = document.getElementById('recDia').value;
            if(n && m && d){ config.recurrentes.push({nombre:n, monto:m, cuenta:c, dia:d}); save(); render(); } 
        }
        
        function addItem(key, id) { 
            const v = document.getElementById(id).value; 
            if(v){ config[key].push(v); save(); render(); } 
        }
        
        function removeItem(key, i) { config[key].splice(i, 1); save(); render(); }
        function agregarMeta(tipo) { const n = document.getElementById('meta_nombre').value, m = document.getElementById('meta_monto').value, f = document.getElementById('meta_fecha').value; if(n && m && f) { config.metas.push({nombre:n, monto:m, fecha:f, tipo:tipo}); save(); vistaActual='home'; render(); } }
        function borrarMeta(i) { config.metas.splice(i,1); save(); render(); }

        render();
    </script>
</body>
</html>
